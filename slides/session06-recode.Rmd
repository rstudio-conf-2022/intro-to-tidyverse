---
title: "Recode variables with `if_else()` and `case_when()`"
subtitle: "Day 2, Session 2"
author: "Deirdre Francks"
date: "July 26, 2022"
output:
  xaringan::moon_reader:
    css: ["default", "assets/academy-theme.css"]
    seal: false
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

# Load packages
library(dplyr)

# Load data
dem <- 
  haven::read_xpt("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/DEMO_E.XPT") %>%
  haven::zap_label() %>%
  transmute(
    seq_no = SEQN,
    age = RIDAGEYR,
    sex = if_else(RIAGENDR == 1, "male", "female"),
  ) 

body <- 
  haven::read_xpt("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BMX_E.XPT") %>%
  haven::zap_label() %>%
  transmute(
    seq_no = SEQN,
    bmi = BMXBMI
  ) 

bp <- 
  haven::read_xpt("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BPX_E.XPT") %>%
  haven::zap_label() %>%
  transmute(
    seq_no = SEQN,
    sys_bp = BPXSY2,
    dias_bp = BPXDI2
  )

fasting <- 
  haven::read_xpt("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/GLU_E.XPT") %>%
  haven::zap_label() %>%
  transmute(
    seq_no = SEQN,
    glucose = LBXGLU
  )

set.seed(123)
 
patients <- 
  inner_join(dem, body, by = "seq_no") %>%
  inner_join(bp) %>%
  inner_join(fasting) %>%
  # inner_join(nhanes_glucose) %>%
  tidyr::drop_na() %>%
  slice_sample(n = 30) %>%
  mutate(
   seq_no = row_number()
  ) %>%
  rename(id = seq_no) %>%
  relocate(
    glucose, .after = "bmi"
  )
```

layout: true

<a class="footer-link" href="https://github.com/rstudio-conf-2022/intro-to-tidyverse">shortlink here</a>

---
class: title-slide

# `r rmarkdown::metadata$title`

### `r rmarkdown::metadata$subtitle`

<div class="title-footer">
  <img src="images/academy-logo.png">
  <div> `r rmarkdown::metadata$date`</div>
</div>

???

Welcome to today's session on recoding variables with `if_else()` and `case_when()`, two functions from the dplyr package. Let's get started.

---

class: middle

# Agenda

1. Review `dplyr::mutate()`
1. Recode with `dplyr::if_else()`
1. Recode with `dplyr::case_when()`
1. Work time: milestone recreation

???

Here's our agenda for this session. You’ve previously learned how to create and modify variables with `mutate()`. In this lesson, you’ll extend this skill by learning several new functions to use inside of `mutate()` to recode a variable based on its existing values.

We'll practice:

* Recoding data using two logical conditions with `if_else()`
* Recoding a variable using multiple conditions with `case_when()`

By the end of this lesson, you should be able to complete your milestone recreation using the hotels dataset. 

---
class: your-turn

# Review #1
Complete this code.

```{r eval = FALSE}
# mutate() review
# TODO: Need dataset for mutate() practice problems
```

???

Let's begin with some review.

**Prompt**: Open the R Markdown (milestone?) file for today's session. Run the setup chunk, then use the `review-1` chunk to complete this review.

---

# `patients` dataset

```{r patients}
patients
```
???

Today we'll work with the `patients` dataset. We have information about age, sex, body mass index (BMI), fasting blood glucose level (mg/dL), and systolic and diastolic blood pressure (mmHg) for 30 patients. 

---
class: your-turn

# Your turn #1

Complete the code to create a column called `sex_recode`, recoding `male` as `0` and `female` as `1`.

```{r your-turn-1, eval = FALSE}
patients %>% 
  mutate(
    sex_recode = ____(sex == "male", true = 0, false = 1)
  )
```


???

Imagine you are tasked with preparing the patient data for use in a program that only accepts the variable `sex` when formatted as 0s (for male) or 1s (for female). You can complete that task by using `if_else()` to recode the variable `sex`.

Think about how `mutate()` will affect your dataset. Will this code modify the column `sex`?

---
class: your-turn

# Your turn #1

Complete the code to create a column called `sex_recode`, recoding `male` as `0` and `female` as `1`.

```{r your-turn-1-solution}
patients %>% 
  mutate(
    sex_recode = if_else(sex == "male", true = 0, false = 1)
  )
```


???

The call to `mutate()` did not alter the `sex` column; it created a new column called `sex_recode`.

---

# Using `if_else()`

```{r if-else, eval = FALSE}
patients %>% 
  mutate(
    sex_recode = if_else(sex == "male", 0, 1)
  )
```

???

`if_else()` takes three arguments to recode its values:

1. The first argument is a logical test to apply to each element of a vector.
1. The second argument is a value to output if the result of the logical test is TRUE.
1. The third argument is a value to output if the result of the logical test is FALSE.

You can explicitly write out `true =` or `false =` for the second and third arguments, but it is more common to see these `if_else()` arguments unlabelled.

---
class: your-turn

# Your turn #2

**Recode the values of systolic blood pressure (`sys_bp`) into two new categories: `"high"` and `"normal"`. Save the result as a new variable named `sys_status`.** Consider a systolic blood pressure of 130 mmHg or above to be “high” and a systolic blood pressure of less than 130 mmHg to be “normal”.

```{r your-turn-2, eval = FALSE}
patients %>% 
  mutate(____)
```

???

Let's do some more practice with `if_else()`. 

---
class: your-turn

# Your turn #2

**Recode the values of systolic  blood pressure (`sys_bp`) into two new categories: `"high"` and `"normal"`. Save the result as a new variable named `sys_status`.** Consider a systolic blood pressure of 130 mmHg or above to be “high” and a systolic blood pressure of less than 130 mmHg to be “normal”.

```{r your-turn-2-solution}
patients %>% 
  mutate(
    sys_status = if_else(sys_bp >= 130, "high", "normal")
  )
```

???

Let's do some more practice with `if_else()`. 

---

# Debug #1

```{r debug-1, error = TRUE}
patients %>%
  mutate(
    sex_recode = if_else(sex == "male", 0, "f")
  )
```

???

What went wrong with this call to `if_else()`? Discuss at your table.

---

# Debug #2

```{r debug-2, error = TRUE}
patients %>% 
    sys_bp_status = if_else(sys_bp >= 130, "high", "normal")
```

???

What is the problem with this call?

---

# Debug #3

```{r debug-3}
patients %>%
  mutate(
    sex_recode = if_else(sex == "male", 1, 0)
  )
```

???

The code intends to recode males as `0`s and females as `1`s. The code runs, but it's not quite what we wanted. Why?

---

# Complex logical conditions

We want to identify which patients require medical intervention based on their age, weight, and blood glucose level. Patients eligible for intervention must meet three criteria:

1. Age 40 or older
1. Blood glucose is 126 mg/dL or greater
1. A BMI of 30 or greater

???

So far you have used `if_else()` with basic logical conditions, but you can recode values based on more complex logical tests.

---

class: your-turn

# Your turn #3

**Add a variable named `intervene` which takes the value `“yes”` for patients who meet the following criteria, and `"no"` for all others.** Save the result as a new tibble called `patients_interventions`.

1. Age 40 or older
1. Blood glucose is 126 mg/dL or greater
1. A BMI of 30 or greater

```{r your-turn-3, eval = FALSE}
patients_interventions <-
  patients %>% 
  mutate(
    ____ = ____(
      ____ & ____ & ____, 
      "yes", 
      "no"
    )
```

---

class: your-turn

# Your turn #3

**Add a variable named `intervene` which takes the value `“yes”` for patients who meet the following criteria, and `"no"` for all others.** Save the result as a new tibble called `patients_interventions`.

1. Age 40 or older
1. Blood glucose is 126 mg/dL or greater
1. A BMI of 30 or greater

```{r your-turn-3-solution}
patients_interventions <- 
  patients %>% 
  mutate(
    intervene = if_else(
      age >= 40 & glucose >= 126 & bmi >= 30, 
      "yes", 
      "no"
    )
  )
```

---
# Complex TRUE and FALSE conditions

```{r patients-interventions}
patients_interventions
```

???

Consider the `patients_interventions` dataset you created in a previous exercise. Imagine that you predict the medical intervention will lower a patient’s BMI by 10% (i.e., `bmi * 0.90`), and you want to add these predicted values as a new variable.

---

class: your-turn

# Your turn #4

**Create a new variable called `bmi_predict` that calculates a 10% reduction in BMI for patients who receive intervention. For all other patients, have `bmi_predict` display the patient’s current BMI.**

```{r your-turn-4, eval = FALSE}
patients_interventions %>% 
  ____
```

---

class: your-turn

# Your turn #4

**Create a new variable called `bmi_predict` that calculates a 10% reduction in BMI for patients who receive intervention. For all other patients, have `bmi_predict` display the patient’s current BMI.**

```{r your-turn-4-solution}
patients_interventions %>% 
  mutate(
    bmi_predict = if_else(
      intervene == "yes", 
      bmi * 0.90, 
      bmi
    )
  )
```

---

class: inverse

# Takeaway

Use this template to recode values with `if_else()`

```{r if_else-syntax, eval = FALSE}
if_else(<LOGICAL TEST>, <DO THIS IF TRUE>, <DO THIS IF FALSE>)
```

???

* `if_else()` is used with a logical test to recode a variable's values in one of two ways. 
* The logical tests can be as complex as needed.
* The `TRUE` and `FALSE` conditions can incorporate R functions and objects.
* When using `if_else()` to recode a column in a table, it must be used within a `mutate()` call.

---

# Multiple conditions

| Blood pressure category         | Systolic Blood Pressure (mmHg)    |
|:--------------------------------|:----------------------------------|
| Normal                          | Below 120                         |
| Elevated                        | 120 to < 130                      |
| Stage 1 Hypertension            | 130 to < 140                      |
| Stage 2 Hypertension            | 140 and above                     |

???

We previously recoded systolic blood pressure of `patients` into 2 weight categories: "high" and "normal", but official [CDC guidelines](https://www.cdc.gov/bloodpressure/facts.htm){target="_blank" rel="noopener noreferrer"} specify 4 categories:

Can we use `if_else()` to recode a variable under more than two conditions? Discuss with your group.

---
class: your-turn

# Your turn #5

**Fill in the blanks below to create a new column called `sys_bp_status` using the function `case_when()`.** 

```{r your-turn-5, eval = FALSE}
patients %>% 
  mutate(
    ____ = ____(
      sys_bp >= 140           ~ "stage 2",
      sys_bp >= 130 & sys_bp  ~ "stage 1",
      sys_bp >= 120 & sys_bp  ~ "elevated",
      sys_bp < 120            ~ "normal"
    )
  )
```

---
class: your-turn

# Your turn #5

**Fill in the blanks below to create a new column called `sys_bp_status` using the function `case_when()`.** 

```{r your-turn-5-solution}
patients %>% 
  mutate(
    sys_bp_status = case_when(
      sys_bp >= 140           ~ "stage 2",
      sys_bp >= 130 & sys_bp  ~ "stage 1",
      sys_bp >= 120 & sys_bp  ~ "elevated",
      sys_bp < 120            ~ "normal"
    )
  )
```

---

# Using `case_when()`

TODO: Insert `case_when()` image

???

`case_when()` has an unusual syntax. The arguments to this function consist of a series of **formulas**, which are written using a tilde (`~`).

* The **left hand side** of each formula is a logical test, e.g. `sys_bp < 120`.  
* The **right hand side** indicates the replacement value when the logical test is `TRUE`.

---
class: your-turn

# Your turn #6

**Recode the values of `glucose` into 3 categories: `"non-diabetic"`, `"pre-diabetic"`, and `"diabetic"`. Use `mutate()` to save the result as a new variable, `diabetes_status`. Save the new tibble as an object called `patients_2`.**

| Diabetes status | Fasting blood glucose |
|:----------------|:----------------------|
| Non-diabetic    | below 100 mg/dL       |
| Pre-diabetic    | 100 - 125 mg/dL       |
| Diabetic        | 126 mg/dL or above    |


???

Let's practice using `case_when()` with the `patients` dataset. Fasting blood glucose levels can be used to test for diabetes. This table summarizes the relevant cutoffs. Use the table to recode the values of `glucose`.

---
class: your-turn

# Your turn #6

**Recode the values of `glucose` into 3 categories: `"non-diabetic"`, `"pre-diabetic"`, and `"diabetic"`. Use `mutate()` to save the result as a new variable, `diabetes_status`. Save the new tibble as an object called `patients_2`.**

```{r your-turn-6-solution, eval = TRUE}
patients_2 <-
  patients %>% 
  mutate(
    diabetes_status = case_when(
      glucose < 100                   ~ "non-diabetic",
      glucose >= 100 & glucose <= 125 ~ "pre-diabetic",
      glucose >= 126                  ~ "diabetic"
    )
  )
```

???

`case_when()` syntax can be a bit tricky to remember at first, but with more practice it will become second nature.

---

# Debug #1

```{r debug-cw-1, error = TRUE}
patients %>% 
  mutate(
    sys_bp_status = case_when(
      sys_bp >= 140           = "stage 2",
      sys_bp >= 130 & sys_bp  = "stage 1",
      sys_bp >= 120 & sys_bp  = "elevated",
      sys_bp < 120            = "normal"
    )
  )
```

???

The code intends to recode `sys_bp` into four categories, as we did before. What has gone wrong?

---

# Debug #2

```{r debug-cw-2, error = TRUE}
patients %>% 
  sys_bp_status = case_when(
    sys_bp >= 140           ~ "stage 2",
    sys_bp >= 130           ~ "stage 1",
    sys_bp >= 120           ~ "elevated",
    sys_bp < 120            ~ "normal"
  )
```

???

What's gone wrong here?

---

# Catch-all conditions

| Diabetes status            | Follow up schedule (in months) |
|:---------------------------|:-------------------------------|
| Diabetic and BMI >= 30     | 1                              |
| Pre-diabetic and BMI >= 30 | 1.5                            |
| All others                 | 2                              |

???

In some cases, you may need a "catch all" condition with `case_when()`. For example, imagine patients are recommended to schedule a follow up visit based on a combination of diabetes and BMI.

---

# Catch-all conditions

```{r catch-all, eval = FALSE}
case_when(
  <LOGICAL TEST> ~ <DO THIS IF TRUE>, 
  <LOGICAL TEST> ~ <DO THIS IF TRUE>,
  TRUE ~ <DO THIS>
)
```

???

When writing the logical test for everyone or everything else, replace the left hand side of the `case_when()` formula with `TRUE`, like this.

---
class: your-turn 

# Your turn #7

**Add a new variable to `patients_2` called `followup` that displays the recommended number of months until follow up for each patient.**

| Diabetes status            | Follow up schedule (in months) |
|:---------------------------|:-------------------------------|
| Diabetic and BMI >= 30     | 1                              |
| Pre-diabetic and BMI >= 30 | 1.5                            |
| All others                 | 2                              |

???

Practice using a catch-all condition.

---
class: your-turn

# Your turn #7

**Add a new variable to `patients_2` called `followup` that displays the recommended number of months until follow up for each patient.**

```{r your-turn-7-solution}
patients_2 %>% 
  mutate(
     followup = case_when(
       diabetes_status == "diabetic" & bmi >= 30 ~ 1, 
       diabetes_status == "pre-diabetic" & bmi >= 30 ~ 1.5,
       TRUE ~ 2,
    )
  )
```

---

# Recoding to `NA`

```{r na-error, error = TRUE}
patients_2 %>% 
  mutate(
     followup = case_when(
       diabetes_status == "diabetic" ~ 1, 
       diabetes_status == "pre-diabetic" ~ 1.5,
       TRUE ~ NA,
    )
  )
```


???

You learn that a new policy is in place and only diabetic and pre-diabetic patients will have follow up visits, regardless of BMI. Follow up visits for all other patients have been cancelled and should be coded as `NA` instead. The variable `followup` needs to be changed accordingly. 

When you want to recode some values to `NA`, filling in the right hand side of the `case_when()` formula with `NA` will usually *NOT* work. **Discuss with your group why that might be.**

The error message gives us a hint why. All right hand side values need to be the same type of data. `NA` is a `logical`, but `followup` needs to be a double.

---

# Recoding to `NA`

|`NA` type          |For use with                     |
|:------------------|:--------------------------------|
| `NA_character_`   | character values, i.e. `"a"`    |
| `NA_real_`        | doubles, i.e. `1`               |
| `NA_integer_`     | integers, i.e. `1L`             |
| `NA_complex_`     | complex numbers, i.e. `1+1i`    |
| `NA`              | logicals, i.e. `TRUE` or `FALSE`|

???

We must use a special type of `NA` value to match the other data type for the column we are creating.

---
class: your-turn

# Your turn #8

**Complete the code to recode `followup` with the appropriate type of missing value.**

```{r your-turn-8, eval = FALSE}
patients_2 %>% 
  mutate(
     followup = case_when(
       diabetes_status == "diabetic" ~ 1, 
       diabetes_status == "pre-diabetic" ~ 1.5,
       TRUE ~ ____,
    )
  )
```

???

Fix the code from earlier using the appropriate `NA` value.

---
class: your-turn

# Your turn #8

**Complete the code to recode `followup` with the appropriate type of missing value.**

```{r your-turn-8-solution}
patients_2 %>% 
  mutate(
    followup = case_when(
      diabetes_status == "diabetic" ~ 1, 
      diabetes_status == "pre-diabetic" ~ 1.5,
      TRUE ~ NA_real_,
    )
  )
```

???
---
class: inverse

# Takeaway

Use this template to recode values with `case_when()`.

```{r case_when-syntax, eval = FALSE}
case_when(
  <LOGICAL TEST> ~ <DO THIS IF TRUE>,
  <LOGICAL TEST> ~ <DO THIS IF TRUE>,
  <LOGICAL TEST> ~ <DO THIS IF TRUE>
)
```

???

* `case_when()` is useful when you want to recode a variable's values using more than logical tests.  

* To create a "catch all" condition, the last logical test should follow the pattern:
  ```
  TRUE ~ <DO THIS>
  ``` 
* To recode values to `NA`, the type of `NA` should match the data type of the other values in recoded columns, e.g. (`NA_real_`, `NA_integer_`, `NA_complex_`, `NA_character_`)

* When using `case_when()` to recode a column in a table, it must be used within a `mutate()` call.
    - Like `if_else()`, you can also use `case_when()` on standalone vectors. You do not *have* to use it within `mutate()`. 
---






